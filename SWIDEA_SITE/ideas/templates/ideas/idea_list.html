{% extends 'ideas/base.html' %}

{% block title %}ì•„ì´ë””ì–´ ëª©ë¡{% endblock %}

{% block content %}
<h1>ì•„ì´ë””ì–´ ëª©ë¡</h1>

<!-- ê²€ìƒ‰ì°½ -->
<form method="GET" action="." class="search-bar">
  <input type="text" name="q" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" value="{{ request.GET.q }}">
  <button type="submit">ğŸ”</button>
</form>

<!-- ì •ë ¬ ì˜µì…˜ -->
<div class="sort-options">
    <a href="?sort=stars">ì°œí•˜ê¸°ìˆœ</a>
    <a href="?sort=name">ì´ë¦„ìˆœ</a>
    <a href="?sort=oldest">ë“±ë¡ìˆœ</a>
    <a href="?sort=latest">ìµœì‹ ìˆœ</a>
</div>

<!-- ì•„ì´ë””ì–´ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
<div class="idea-container">
  {% for idea in ideas %}
    <div class="idea-card">

      <!-- ì´ë¯¸ì§€ -->
      <img src="{{ idea.image.url }}" alt="{{ idea.title }} ì´ë¯¸ì§€">

      <!-- ì œëª© -->
      <h3>
        <a href="{% url 'ideas:idea_detail' idea.id %}">{{ idea.title }}</a>
      </h3>

      <!-- ì°œ ë²„íŠ¼ -->
      <button class="star-toggle-btn" data-idea-id="{{ idea.id }}">
        {% if idea.id in star_dict %}
          â­ ì°œì·¨ì†Œ
        {% else %}
          â˜† ì°œí•˜ê¸°
        {% endif %}
      </button>

      <!-- ê´€ì‹¬ë„ -->
      <p>
        ê´€ì‹¬ë„:
        <span class="interest-count" data-idea-id="{{ idea.id }}">{{ idea.interest }}</span>
        {% if user.is_authenticated %}
          <button class="interest-btn" data-idea-id="{{ idea.id }}" data-action="increase">+</button>
          <button class="interest-btn" data-idea-id="{{ idea.id }}" data-action="decrease">-</button>
        {% endif %}
      </p>

      <!-- ê°œë°œíˆ´ -->
      <p>ê°œë°œíˆ´: {{ idea.devtool.name }}</p>

    </div>
  {% empty %}
    <p>ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endfor %}
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
<div class="pagination">
  <span>
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">ì´ì „</a>
    {% endif %}

    í˜ì´ì§€ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">ë‹¤ìŒ</a>
    {% endif %}
  </span>
</div>

<!-- JS -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const starButtons = document.querySelectorAll('.star-toggle-btn');

      // ì°œ ë²„íŠ¼ ì²˜ë¦¬
      starButtons.forEach(button => {
          button.addEventListener('click', function(){
              const ideaId = this.dataset.ideaId;

              fetch(`/star/${ideaId}/`, {
                  method: 'POST',
                  headers: {
                      'X-CSRFToken' : '{{ csrf_token }}',
                  },
              })
              .then(response => {
                  if(response.ok){
                      this.textContent = this.textContent.includes('â˜†') ? 'â­ ì°œì·¨ì†Œ' : 'â˜† ì°œí•˜ê¸°';
                  } else {
                      alert('ì‹¤íŒ¨í–ˆì–´ìš”!');
                  }
              });
          });
      });

      // ê´€ì‹¬ë„ ì²˜ë¦¬
      const interestButtons = document.querySelectorAll('.interest-btn');
      interestButtons.forEach(button => {
          button.addEventListener('click', function() {
              const ideaId = this.dataset.ideaId;
              const action = this.dataset.action;

              fetch(`/interest/${ideaId}/`, {
                  method: 'POST',
                  headers: {
                      'X-CSRFToken': '{{ csrf_token }}',
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: `action=${action}`
              })
              .then(response=> response.json())
              .then(data => {
                  if (data.success) {
                      const countSpan = document.querySelector(`.interest-count[data-idea-id="${ideaId}"]`);
                      countSpan.textContent = data.interest;
                  } else{
                      alert('ê´€ì‹¬ë„ ë³€ê²½ ì‹¤íŒ¨');
                  }
              });
          });
      });
  });
</script>

{% endblock %}
