{% extends 'ideas/base.html' %}

{% block title %}아이디어 목록{% endblock %}

{% block content %}
<h1>아이디어 목록</h1>

<!-- 사용자가 클릭하면 GET 방식으로 URL에 ?sort=~~ 파라미터가 붙음 -->
<p>
    <a href="?sort=stars">찜하기순</a>
    <a href="?sort=name">이름순</a>
    <a href="?sort=oldest">등록순</a>
    <a href="?sort=latest">최신순</a>
</p>

{% for idea in ideas %}
<div style="margin-bottom: 20px;">
    <!--제목 클릭하면 다른 페이지로 연결-->
    <a href="{% url 'ideas:idea_detail' idea.id %}">{{ idea.title }}</a><br>
    <!--찜 버튼-->
    <button class="star-toggle-btn" data-idea-id="{{ idea.id }}">
        {% if idea.id in star_dict %}
            ⭐ 찜취소
        {% else %}
            ☆ 찜하기
        {% endif %}
    </button>
    <!--썸네일 이미지 추가-->
    <img src="{{ idea.image.url }}" width="200"><br>

    <p>
        관심도: <span class="interest-count" data-idea-id="{{ idea.id }}">{{ idea.interest }}</span>
        {% if user.is_authenticated %}
            <button class="interest-btn" data-idea-id="{{ idea.id }}" data-action="increase">+</button>
            <button class="interest-btn" data-idea-id="{{ idea.id }}" data-action="decrease">-</button>
        {% endif %}
    </p>


    <p>개발툴: {{ idea.devtool.name }}</p>
    
</div>
{% empty %}
    <p>등록된 아이디어가 없습니다.</p>
{% endfor %}

<!--페이지네이션 링크-->
<div>
    <span>
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">이전</a>
        {% endif %}

        페이지 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">다음</a>
        {% endif %}
    </span>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const starButtons = document.querySelectorAll('.star-toggle-btn');

        /*찜 버튼*/
        starButtons.forEach(button => {
            button.addEventListener('click', function(){
                const ideaId = this.dataset.ideaId;

                fetch(`/star/${ideaId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken' : '{{ csrf_token }}',
                    },
                })
                .then(response => {
                    if(response.ok){
                        this.textContent = this.textContent.includes('☆') ? '⭐ 찜취소' : '☆ 찜하기';
                    } else {
                        alert('실패했어요!');
                    }
                });
            });
        });

        //관심도 Ajax 처리//
            const interestButtons = document.querySelectorAll('.interest-btn');
            interestButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const ideaId = this.dataset.ideaId;
                    const action = this.dataset.action;

                    fetch(`/interest/${ideaId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=${action}`
                    })
                    .then(response=> response.json())
                    .then(data => {
                        if (data.success) {
                            const countSpan = document.querySelector(`.interest-count[data-idea-id="${ideaId}"]`);
                            countSpan.textContent = data.interest;
                        } else{
                            alert('관심도 변경 실패');
                        }
                    });
                });
            });
        });    

</script>

{% endblock %}